require 'rails_helper'

RSpec.describe StudyJsonRecord::ProcessorV2, type: :model do
    describe 'detailed_description_data' do

        it 'should test detailed_description_data' do
            expected_data = {
                nct_id: 'NCT03630471',
                description: "Background and rationale:\n\nThis study is part of a larger research program called PRIDE (PRemIum for aDolEscents) for which the goals are to:\n\n* develop a trans-diagnostic, stepped-care intervention targeting common mental disorders in school-going adolescents in India; and\n* evaluate its effectiveness in reducing symptom severity and improving recovery rates among adolescent participants\n\nThe components of the stepped-care intervention will be evaluated in separate, linked studies. The main aim of the current trial is to evaluate the effectiveness of a low-intensity problem-solving intervention (the first step of the PRIDE stepped-care intervention) delivered by school counsellors for adolescents with common mental health problems, when compared with enhanced usual care (EUC).\n\nThe primary hypothesis is that the intervention will be superior to the EUC control condition in reducing the severity of self-reported mental health symptoms and prioritized problems at six weeks post-randomization.\n\nStudy design and setting:\n\nThis is a parallel-arm, individually randomized controlled trial with equal allocation of participants between arms. The trial will be conducted in six Government-run secondary schools (Grade 9 to 12; approximately corresponding to 13-20 years of age) from the National Capital Territory of Delhi, India. A process evaluation will be nested in the trial to provide findings that will assist in the interpretation of the trial results and to inform potential implementation of the PRIDE intervention on a wider scale.\n\nEligibility criteria: see 'Eligibility' section.\n\nInterventions: see 'Arms and Interventions' section.\n\nScreening measures: Referred adolescents will be screened for common mental health difficulties, impact and chronicity using the SDQ (Goodman et al., 2000), according to the eligibility criteria set out below.\n\nSociodemographic information: This will be obtained from all enrolled participants through an interviewer-administered questionnaire, with responses entered directly into a tablet computer.\n\nOutcome measures: see 'Outcome Measures' section.\n\nEconomic measures: The costs associated with the introduction of the experimental and control arm interventions will be estimated by adding the personnel costs for counsellors and supervisors, together with fixed costs of training (venue/per diem), furniture and supplies. All costs will be reported in Indian Rupees and then converted to US Dollars at the average daily exchange rate over the preceding 12 months.\n\nProcess measures:\n\nProcess data on enrollment, randomization and assessment procedures will be obtained from researcher-completed record forms. These will be collated to obtain assent/consent rates of adolescents and parents (and reasons for missing assent/consent); randomization rates (and reasons for randomization errors); completion rates of baseline and follow-up outcome assessments (and reasons for non-completion); and time lags between intended and completed assessments (and reasons for deviating from targets). In addition, motivations for help-seeking and expectancies for the school counselling program will be explored at the time of eligibility assessment through a brief qualitative interview with a sub-sample of referred students.\n\nIntervention processes will be assessed using additional data sources. Counsellor-completed session record forms will be used to obtain process data on duration, spacing and frequency of attended sessions (and reasons for non-attendance); and intervention uptake and completion rates (and reasons for pre-intervention and mid-intervention drop-out). Participants' adherence to treatment and potential engagement challenges will be assessed using checklists within the same record forms, indicating whether or not the student completed practice exercises at home, used the POD (Problems-Options-Do it yourself) booklets at home, brought the POD booklets to the session, and demonstrated understanding of POD booklets and session content. Use of POD booklets will be assessed in each arm of the trial at 6- and 12-week follow-up assessments using a brief adolescent-reported measure that asks about estimated frequency of home use and perceived helpfulness of POD booklets in the preceding 6 weeks. Service satisfaction data will also be obtained from participants in each trial arm at 12 weeks using the 8-item Client Satisfaction Questionnaire (CSQ-8) (Larsen et al., 1979). Supplementary questions will elicit open-ended written feedback on the most helpful aspects of the available intervention and suggested modifications.\n\nIntervention fidelity will be assessed using independent ratings of audio-recorded sessions: 10% of all recordings will be selected at random and rated by a psychologist who is not directly involved with supervision of the intervention providers.\n\nSample size:\n\nSample size estimations have been produced for two co-primary outcomes: mental health symptoms (SDQ Total Difficulties score) and idiographic problems (YTP score). A Bonferroni correction has been used to adjust for multiple primary outcomes. Following pilot work that indicated large (uncontrolled) effect sizes, the investigators have conservatively assumed that the intervention will be associated with an effect size of 0.5 (difference in means/SD) on both the primary outcomes with 90% power at 6 weeks post-randomization. The investigators have also assumed a loss to follow up of 15% over 6 weeks, based on pilot work. Based on these assumptions and a 1:1 allocation ratio for individual randomization, a total of 240 participants will be required. This sample size provides 80% power to detect an ES of 0.44.\n\nRecruitment methods and sampling frame:\n\nA combination of whole-school and classroom-based sensitization methods will be used to generate referrals into the trial. This will include posters, teacher briefings and classroom-based information sessions for students. Referrals may be initiated in a number of ways: (1) adolescents can directly approach a researcher following a classroom information session; (2) adolescents can provide their contact details in a 'drop box' placed in the school; or (3) adolescents can request a referral through a teacher (or a teacher may raise the prospect of referral directly with a student before initiating the same). Referred participants will be assessed for eligibility using the SDQ; those meeting eligibility criteria will be invited to participate in the trial. Referred adolescents who do not meet eligibility criteria will receive a handout on self-care strategies.\n\nIn the academic year 2018-19, there are 172 class divisions of grades 9-12 in the six collaborating schools in New Delhi, and approximately 50 students per class. Seventy classes will participate in an embedded recruitment trial (see separate protocol: NCT03633916). The host intervention trial will recruit participants originating from the 70 classes sampled in the embedded recruitment trial, as well as participants drawn from other classes as needed. The precise schedule of recruitment activities in the remaining 102 classes will be calibrated according to referral patterns and caseload capacity for intervention providers in the various schools.\n\nAssent/consent procedures:\n\nReferred adolescents will be invited to meet with a researcher when a 2-stage consent process will be initiated.\n\n1. Assent/consent for using screening data: All referred students who are screened for eligibility will be provided with written information and structured verbal information about the potential use of their screening data for evaluation of help-seeking patterns. Assent, consent will be obtained on signed consent forms.\n2. Assent/consent for trial participation: Eligible students will be provided with additional structured verbal information and a printed participant information sheet about trial participation. Assent will be sought for adolescents who are below 18 years of age, and consent will be sought for adolescents who are 18 years of age or older. For assenting participants aged below 18 years of age, consent from a parent/guardian will be sought by a researcher. This will involve two levels of consent: consent for their child to participate in the trial, and consent for a parent's/guardian's own participation in the study. The informed assent/consent procedure with adolescents will be completed during school hours, while the parent/guardian consent process will be completed at the family's home or another convenient location. Details of assenting/consenting adolescents and consenting parents (and those declining to participate) will be logged on an ongoing basis, along with reasons for non-participation.\n\nData collection procedures (see 'Outcome Measures' for detailed descriptions of measures referenced below):\n\nField researchers will administer outcome measures in schools, at home or other convenient locations. The adolescent-reported SDQ will be collected by a field researcher on a digital tablet device, and will also serve as the basis for eligibility screening. Other baseline assessments will be completed as soon as possible after assent/consent procedures are completed (and ideally on the same day). The YTP will be administered on paper while the remaining scales will be administered on a digital tablet device. The YTP will be administered on paper as it asks the participants to describe, prioritize and score their three main problems; the same list of problems will be rated again during follow-up assessments (see below). Adolescents will also be assessed on the PSS-4 and SWEMWBS. Index parents will be invited to complete the SDQ only. Sociodemographic data from the adolescent and parent/guardian will also be collected on digital tablets.\n\nFollow-up assessments will be completed at 6 and 12 weeks post-randomization. The 6-week outcome is the primary end-point, as the optimal effect of the intervention is expected to occur immediately after the intervention has been completed. The 12-week end-point is included to evaluate the durability of intervention effects. The CSQ-8 (a process measure of service satisfaction) will be collected at 12 weeks post-randomization only. Additionally, all adolescents will complete a self-report measure on the use of the intervention materials (problem-solving booklets) provided in the intervention and control arms.\n\nData analysis plan:\n\nDescriptive analyses: Initial analyses will compare baseline characteristics of referred adolescents who did and did were not enrolled into the trial for various reasons. Baseline characteristics of enrolled participants will be compared between trial arms. Findings will be reported as per the CONSORT guidelines, using intention-to-treat analysis, including a trial flow chart.\n\nOutcome measures will be summarized at recruitment, at 6- and 12-week follow up by trial arm, and overall. These will be summarized by means (standard deviation), medians (interquartile range), or numbers and proportions as appropriate. For continuous outcomes, histograms will also be plotted within each arm to assess how closely the scales follow a normal distribution. This will determine how the outcomes are described as well as the choice of inferential analysis method.\n\nOutcome analyses: The primary analyses will be on an intention-to-treat basis at the 6-week end-point, adjusted for baseline values of the outcome measure; school (as a fixed effect in the analysis) to allow for within-school clustering, counsellor variation (as a random effect); and variables for which randomization did not achieve reasonable balance between the arms at baseline, or those associated with missing outcome data. Intervention effects will be presented as adjusted mean differences and effect sizes (ES), defined as standardized mean differences.\n\nFor continuous variables, the analysis of secondary and exploratory outcomes will use similar methods to the primary outcome analysis for continuous variables. For the binary outcome (remission), the intervention effect will be reported as the adjusted odds ratio with 95% CIs. Generalized (linear or logistic) random-effects regression models will be used, adjusting for baseline outcome score and clustering, and other baseline variables as above. For outcomes to be examined over the 12-week follow-up period (other than remission), regression models will include a variable to represent 'time' in order to indicate whether the data were collected at the 6- or 12-week end-point. To assess whether the intervention effect varies over time, an intervention x time interaction term will be fitted to allow for a different intervention effect at 6 vs 12 months, although this will not be highly powered.\n\nWe will explore potential moderators of intervention effects, with respect to a priori defined modifiers (i.e. chronicity of mental health difficulties, severity of mental health difficulties, YTP type, SDQ caseness profile). We will fit relevant interaction terms and test for heterogeneity of intervention effects in regression models. A mediation analysis will be conducted to examine whether the theoretically-driven a priori factor (perceived stress at 6 weeks) mediates the effects of the intervention on primary outcomes (i.e. mental health symptoms and idiographic problems) at 12 weeks. Additionally, intervention effects for students who receive fewer sessions than prescribed will be estimated using the Complier Average Causal Effect structural equation model.\n\nProcess evaluation: We will undertake descriptive statistical analysis of quantitative process data in order to explore the implementation of intervention procedures. In addition, thematic analysis will be used to code and organise qualitative interview data on intervention expectancies (assessed prior to enrolment) and qualitative written feedback on service satisfaction (assessed at 12-week follow-up). Findings from the various data sources will be triangulated and used to develop explanatory hypotheses about potential differences in intervention delivery and engagement across schools, subgroups of participants and providers. Process evaluation findings will be used to facilitate interpretation of the main trial results. The trial statisticians may conduct further analyses to test hypotheses generated from integration of the process evaluation and trial outcome data.\n\nCost-effectiveness analysis: The costs associated with the introduction of the PRIDE and control arm interventions will be estimated by adding the fixed costs of materials and personnel costs."
            }
            hash = JSON.parse(File.read('spec/support/json_data/NCT03630471.json'))
            hash = JSON.parse(File.read('spec/support/json_data/NCT03630471.json'))
            processor = StudyJsonRecord::ProcessorV2.new(hash)
            expect(processor.detailed_description_data).to eq(expected_data)
        end
    end
    
end  